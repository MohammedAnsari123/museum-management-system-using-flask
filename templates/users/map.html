{% extends "base.html" %}

{% block title %}Interactive Map - PixelPast{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        z-index: 1;
    }

    .map-container {
        position: relative;
    }

    .map-overlay {
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        max-width: 300px;
    }
</style>

<div class="card dashboard-header">
    <h2><i class="fas fa-map-marked-alt"></i> Explore Museums on Map</h2>
    <p>Find museums near you or plan your next trip!</p>
</div>

<div class="map-container">
    <div id="map"></div>
    <div class="map-overlay">
        <h4><i class="fas fa-info-circle"></i> Map Info</h4>
        <p>Click on any marker to see museum details and book tickets.</p>
        <div id="user-location-status"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize Map centered on India
    var map = L.map('map').setView([20.5937, 78.9629], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Museum Data passed from Backend
    var museums = {{ museums_json | safe }};

    museums.forEach(function (m) {
        if (m.latitude && m.longitude) {
            var marker = L.marker([m.latitude, m.longitude]).addTo(map);

            var popupContent = `
                <div style="text-align: center;">
                    <h4 style="margin-bottom: 5px; color: var(--primary-color);">${m.museum_name}</h4>
                    <span class="badge" style="font-size: 0.7rem;">${m.museum_type}</span>
                    <p style="margin: 5px 0;">${m.city}, ${m.state}</p>
                    <a href="/museums?q=${encodeURIComponent(m.museum_name)}" class="btn btn-sm btn-primary" style="margin-top: 5px;">View Details</a>
                </div>
            `;

            marker.bindPopup(popupContent);
        }
    });

    // User Location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;

            var userIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            L.marker([lat, lng], { icon: userIcon }).addTo(map)
                .bindPopup("<b>You are here!</b>").openPopup();

            // Optional: Fly to user
            // map.flyTo([lat, lng], 10);
            document.getElementById('user-location-status').innerHTML = '<small style="color: green;">Location found!</small>';
        }, function () {
            document.getElementById('user-location-status').innerHTML = '<small style="color: orange;">Location access denied.</small>';
        });
    }
</script>
{% endblock %}